{% load static %}
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Tasks - TaskFlow</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" href="{% static 'css/style.css'%}" />
    </head>
    <body>
        <div
            class="d-md-none p-3 bg-white border-bottom d-flex justify-content-between align-items-center fixed-top">
            <div class="d-flex align-items-center gap-1">
                <img
                    src="{% static 'image/Tasklogo.png' %}"
                    alt="Logo"
                    style="width: 35px; object-fit: contain" />
                <h1 class="h3 fw-bold m-0 brand-name">TaskFlow</h1>
            </div>
            <button
                class="btn btn-light"
                type="button"
                data-bs-toggle="offcanvas"
                data-bs-target="#sidebarMenu">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>

        <aside
            class="sidebar offcanvas-md offcanvas-start d-flex flex-column py-4"
            tabindex="-1"
            id="sidebarMenu">
            <div class="px-4 mb-4">
                <div class="d-flex align-items-center gap-1 mb-2">
                    <img
                        src="{% static 'image/Tasklogo.png' %}"
                        alt="Logo"
                        style="width: 40px; object-fit: contain" />
                    <h1 class="h3 fw-bold m-0 brand-name">TaskFlow</h1>
                </div>
                <div class="d-flex align-items-center text-muted small">
                    <i class="fa-solid fa-graduation-cap me-2"></i>
                    <span>Student</span>
                </div>
                <div class="small text-secondary fw-bold">Demo User</div>
            </div>
            <nav class="nav flex-column px-3 flex-grow-1">
                <a href="{% url 'dashboard'%}" class="nav-link"
                    ><i class="fa-solid fa-grip-vertical me-2 w-25px"></i>
                    Dashboard</a
                >
                <a href="{% url 'tasks'%}" class="nav-link active"
                    ><i class="fa-solid fa-list-check me-2 w-25px"></i> Tasks</a
                >
                <a href="analytics.html" class="nav-link"
                    ><i class="fa-solid fa-chart-line me-2 w-25px"></i>
                    Analytics</a
                >
                <a href="settings.html" class="nav-link"
                    ><i class="fa-solid fa-gear me-2 w-25px"></i> Settings</a
                >
            </nav>
            <div class="px-3 mt-auto">
                <a href="index.html" class="logout-link"
                    ><i class="fa-solid fa-arrow-right-from-bracket me-2"></i>
                    Logout</a
                >
            </div>
        </aside>

        <main class="content-area pt-5 pt-md-4">
            <header
                class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h2 class="h3 fw-bold">My Tasks</h2>
                    <p class="text-muted small m-0">{% now "l, F j, Y" %}</p>
                </div>
                <button
                    class="btn bg-primary-custom btn-sm rounded pt-2 pb-2"
                    data-bs-toggle="modal"
                    data-bs-target="#taskModal">
                    <i class="fa-solid fa-plus me-1"></i> New Task
                </button>
            </header>

            <div class="row g-2 mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"
                            ><i
                                class="fa-solid fa-magnifying-glass text-muted"></i
                        ></span>
                        <input
                            type="text"
                            class="form-control border-start-0"
                            placeholder="Search tasks..." />
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select">
                        <option>All Categories</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select">
                        <option>All Subjects</option>
                    </select>
                </div>
            </div>

            <div
                class="nav nav-pills w-100 mb-4 bg-light p-1 rounded-3 d-flex"
                role="tablist">
                <button
                    class="btn bg-custom-tab shadow-sm text-dark fw-bold flex-fill active"
                    data-bs-toggle="tab"
                    data-bs-target="#pending-tab"
                    type="button"
                    role="tab">
                    Pending ({{ tasks|length }})
                </button>
                <button
                    class="btn btn-link text-decoration-none text-muted flex-fill"
                    data-bs-toggle="tab"
                    data-bs-target="#progress-tab"
                    type="button"
                    role="tab">
                    In Progress ({{ in_progress_tasks|length }})
                </button>
                <button
                    class="btn btn-link text-decoration-none text-muted flex-fill"
                    data-bs-toggle="tab"
                    data-bs-target="#completed-tab"
                    type="button"
                    role="tab">
                    Completed ({{ completed_tasks|length }})
                </button>
            </div>
            <div class="tab-content">
                <div
                    class="tab-pane fade show active"
                    id="pending-tab"
                    role="tabpanel">
                    {% for task in tasks %}
                    <div class="tasks-list">
                        <div
                            class="task-card p-3 mb-3 {% if task.priority == 'High' %}border-danger{% endif %}">
                            <div
                                class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center gap-2">
                                    {% if task.priority == "High" %}
                                    <h3
                                        class="h6 fw-bold m-0"
                                        style="color: #dc3545">
                                        {{ task.task }}
                                    </h3>
                                    {% elif task.priority == "Medium" %}
                                    <h3
                                        class="h6 fw-bold m-0"
                                        style="color: #fd7d14">
                                        {{ task.task }}
                                    </h3>
                                    {% else %}
                                    <h3
                                        class="h6 fw-bold m-0"
                                        style="color: #198754">
                                        {{ task.task }}
                                    </h3>
                                    {% endif %}
                                </div>

                                <div class="d-flex gap-1">
                                    <a
                                        href="{% url 'update_status' task.id 'In Progress' %}"
                                        class="btn btn-light btn-sm"
                                        title="Start Task">
                                        <i
                                            class="fa-regular fa-circle-play"></i>
                                    </a>
                                    <div class="dropdown">
                                        <button
                                            class="btn btn-light btn-sm"
                                            type="button"
                                            data-bs-toggle="dropdown"
                                            aria-expanded="false">
                                            <i
                                                class="fa-solid fa-ellipsis-vertical"></i>
                                        </button>
                                        <ul
                                            class="dropdown-menu shadow-sm border-0"
                                            style="min-width: 120px">
                                            <li>
                                                <a
                                                    class="dropdown-item list small fw-bold"
                                                    href="#"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#editTaskModal{{ task.id }}">
                                                    <i
                                                        class="fa-solid fa-pen text-dark me-2"></i>
                                                    Edit
                                                </a>
                                            </li>
                                            <li>
                                                <hr class="dropdown-divider" />
                                            </li>
                                            <li>
                                                <a
                                                    class="dropdown-item small fw-bold text-danger"
                                                    href="{% url 'delete_task' task.id %}">
                                                    <i
                                                        class="fa-solid fa-trash me-2"></i>
                                                    Delete
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex gap-4 text-muted small mb-3">
                                <span
                                    ><i class="fa-regular fa-clock me-1"></i>
                                    {{task.duration|default:"30" }} min</span
                                >
                                <span
                                    ><i class="fa-regular fa-calendar me-1"></i>
                                    {{ task.deadline|date:"M d, Y" }}</span
                                >
                            </div>

                            <div class="d-flex gap-2">
                                {% if task.priority == 'High' %}
                                <span
                                    class="tag"
                                    style="
                                        background-color: #f8d7da;
                                        color: #dc3545;
                                    ">
                                    {{ task.priority }}
                                </span>
                                {% elif task.priority == 'Medium' %}
                                <span
                                    class="tag"
                                    style="
                                        background-color: #fff3cd;
                                        color: #856404;
                                    ">
                                    {{ task.priority }}
                                </span>
                                {% else %}
                                <span
                                    class="tag"
                                    style="
                                        background-color: #d1e7dd;
                                        color: #0f5132;
                                    ">
                                    {{ task.priority }}
                                </span>
                                {% endif %}

                                <span class="tag pending"
                                    >{{ task.status }}</span
                                >
                            </div>
                        </div>
                    </div>
                    <div
                        class="modal fade"
                        id="editTaskModal{{ task.id }}"
                        tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header border-0 pb-0">
                                    <h5 class="modal-title fw-bold">
                                        Edit Task
                                    </h5>
                                    <button
                                        type="button"
                                        class="btn-close"
                                        data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form
                                        action="{% url 'edit_task' task.id %}"
                                        method="POST">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label
                                                class="form-label fw-bold small"
                                                >Task Name</label
                                            >
                                            <input
                                                type="text"
                                                name="task"
                                                class="form-control bg-light border-0"
                                                value="{{ task.task }}"
                                                required />
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label
                                                    class="form-label fw-bold small"
                                                    >Priority</label
                                                >
                                                <select
                                                    name="priority"
                                                    class="form-select bg-light border-0">
                                                    <option {% if task.priority == 'High' %}selected{% endif %}>High</option>
                                                    <option {% if task.priority == 'Medium' %}selected{% endif %}>Medium</option>
                                                    <option {% if task.priority == 'Low' %}selected{% endif %}>Low</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <label
                                                    class="form-label fw-bold small"
                                                    >Deadline</label
                                                >
                                                <input
                                                    type="date"
                                                    name="deadline"
                                                    class="form-control bg-light border-0"
                                                    value="{{ task.deadline|date:'Y-m-d' }}" />
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <label
                                                class="form-label fw-bold small"
                                                >Duration (min)</label
                                            >
                                            <input
                                                type="number"
                                                name="duration"
                                                class="form-control bg-light border-0"
                                                value="{{ task.duration }}"
                                                required />
                                        </div>

                                        <div
                                            class="d-flex justify-content-end gap-2">
                                            <button
                                                type="button"
                                                class="btn btn-light text-muted fw-bold"
                                                data-bs-dismiss="modal">
                                                Cancel
                                            </button>
                                            <button
                                                type="submit"
                                                class="btn bg-primary-custom fw-bold">
                                                Save Changes
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted">
                        <i
                            class="fa-solid fa-check-circle fs-1 mb-3 text-light"></i>
                        <p>No pending tasks. You're all caught up!</p>
                    </div>
                    {% endfor %}
                </div>
                <div class="tab-pane fade" id="progress-tab" role="tabpanel">
                    {% for task in in_progress_tasks %}
                    <div class="tasks-list">
                        <div class="task-card p-3 mb-3">
                            <div
                                class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center gap-2">
                                    <h3
                                        class="h6 fw-bold m-0"
                                        style="color: #fd7d14">
                                        {{ task.task }}
                                    </h3>
                                </div>
                                <div class="d-flex gap-1">
                                    <a
                                        href="{% url 'update_status' task.id 'Pending' %}"
                                        class="btn btn-light btn-sm text-dark"
                                        title="Stop & Undo">
                                        <i class="fa-solid fa-stop"></i>
                                    </a>
                                    <a
                                        href="{% url 'update_status' task.id 'Completed' %}"
                                        class="btn btn-light btn-sm"
                                        title="Complete Task">
                                        <i
                                            class="fa-solid fa-check fa-regular"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="d-flex gap-4 text-muted small mb-3">
                                <span class="fw-bold">
                                    <i class="fa-regular fa-clock me-1"></i>
                                    <span
                                        class="countdown-timer"
                                        data-start="{{ task.started_at|date:'c' }}"
                                        data-duration="{{ task.duration }}"
                                        data-complete-url="{% url 'update_status' task.id 'Completed' %}">
                                        Calculating...
                                    </span>
                                </span>
                            </div>
                            <div class="d-flex gap-2">
                                <span
                                    class="tag"
                                    style="
                                        background-color: #fff3cd;
                                        color: #856404;
                                    "
                                    >{{ task.status }}</span
                                >
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted">
                        <p>No tasks currently in progress.</p>
                    </div>
                    {% endfor %}
                </div>
                <div class="tab-pane fade" id="completed-tab" role="tabpanel">
                    {% for task in completed_tasks %}
                    <div class="tasks-list">
                        <div
                            class="task-card p-3 mb-3 border-success opacity-75">
                            <div
                                class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center gap-2">
                                    <h3 class="h6 fw-bold m-0 text-success">
                                        <del>{{ task.task }}</del>
                                    </h3>
                                </div>
                                <div class="d-flex gap-1">
                                    <a
                                        href="{% url 'update_status' task.id 'Pending' %}"
                                        class="btn btn-light btn-sm"
                                        title="Undo Task">
                                        <i
                                            class="fa-solid fa-rotate-left text-muted"></i>
                                    </a>
                                    <a
                                        class="btn btn-light btn-sm fw-bold text-danger"
                                        href="{% url 'delete_task' task.id %}"
                                        title="Delete Task">
                                        <i class="fa-solid fa-trash"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <span class="tag bg-success text-white"
                                    >{{ task.status }}</span
                                >
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted">
                        <p>No completed tasks yet. Let's get to work!</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </main>

        <div class="modal fade" id="taskModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-0">
                        <div>
                            <h5 class="modal-title fw-bold">Create New Task</h5>
                            <p class="text-muted small m-0">
                                Add a new task to your workflow
                            </p>
                        </div>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form action="{% url 'addtask' %} " method="POST">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label fw-bold small"
                                    >Task Name
                                    <span class="text-danger">*</span></label
                                >
                                <input
                                    type="text"
                                    name="task"
                                    class="form-control bg-light border-0"
                                    required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold small"
                                    >Description</label
                                >
                                <textarea
                                    class="form-control bg-light border-0"
                                    rows="3"></textarea>
                            </div>
                            <div class="row mb-3">
                                <!-- <div class="col-6">
                                    <label class="form-label fw-bold small"
                                        >Category</label
                                    >
                                    <select
                                        class="form-select bg-light border-0">
                                        <option>Assignment</option>
                                    </select>
                                </div> -->
                                <div class="col-6">
                                    <label class="form-label fw-bold small"
                                        >Priority</label
                                    >
                                    <select
                                        name="priority"
                                        class="form-select bg-light border-0">
                                        <option>High</option>
                                        <option>Medium</option>
                                        <option>Low</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-bold small"
                                        >Deadline</label
                                    >
                                    <input
                                        type="date"
                                        name="deadline"
                                        class="form-control bg-light border-0"
                                        required />
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold small"
                                    >Duration (min)</label
                                >
                                <input
                                    type="number"
                                    name="duration"
                                    class="form-control bg-light border-0"
                                    value="30"
                                    required />
                            </div>
                            <div class="form-check form-switch mb-4">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    role="switch" />
                                <label
                                    class="form-check-label fw-bold small ms-2"
                                    >Hard Deadline (Cannot be moved)</label
                                >
                            </div>
                            <div class="d-flex justify-content-end gap-2">
                                <button
                                    type="button"
                                    class="btn btn-light text-muted fw-bold"
                                    data-bs-dismiss="modal">
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    class="btn bg-primary-custom fw-bold">
                                    Create Task
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                /* --- 1. Form Reset Script --- */
                const taskModal = document.getElementById("taskModal");
                if (taskModal) {
                    taskModal.addEventListener("hidden.bs.modal", function () {
                        const form = taskModal.querySelector("form");
                        if (form) form.reset();
                    });
                }

                /* --- 2. Tab Button Class Swap Script --- */
                // Grab all your tab buttons
                const tabButtons = document.querySelectorAll(
                    'button[data-bs-toggle="tab"]',
                );

                tabButtons.forEach((button) => {
                    // Listen for Bootstrap's built-in tab switch event
                    button.addEventListener("shown.bs.tab", function (event) {
                        // The button you just clicked (make it look active)
                        event.target.classList.remove(
                            "btn-link",
                            "text-decoration-none",
                            "text-muted",
                        );
                        event.target.classList.add(
                            "bg-custom-tab",
                            "shadow-sm",
                            "text-dark",
                            "fw-bold",
                        );
                        // The button that used to be active (make it look inactive)
                        if (event.relatedTarget) {
                            event.relatedTarget.classList.remove(
                                "bg-custom-tab",
                                "shadow-sm",
                                "text-dark",
                                "fw-bold",
                            );
                            event.relatedTarget.classList.add(
                                "btn-link",
                                "text-decoration-none",
                                "text-muted",
                            );
                        }
                    });
                });
                /* --- 3. Live Countdown Timer Engine --- */
                const timers = document.querySelectorAll(".countdown-timer");

                if (timers.length > 0) {
                    setInterval(function () {
                        const now = new Date().getTime();

                        timers.forEach((timer) => {
                            // Get the start time and duration from the HTML attributes
                            const startTimeStr =
                                timer.getAttribute("data-start");
                            const durationMins = parseInt(
                                timer.getAttribute("data-duration"),
                            );
                            const completeUrl =
                                timer.getAttribute("data-complete-url");

                            if (startTimeStr) {
                                const startTime = new Date(
                                    startTimeStr,
                                ).getTime();
                                // Calculate exact end time (start time + duration in milliseconds)
                                const endTime =
                                    startTime + durationMins * 60 * 1000;

                                // Find the difference
                                const distance = endTime - now;

                                if (distance <= 0) {
                                    // Time is up! Automatically complete the task.
                                    timer.innerHTML = "00:00 - Completing...";
                                    window.location.href = completeUrl;
                                } else {
                                    // Calculate minutes and seconds
                                    const minutes = Math.floor(
                                        (distance % (1000 * 60 * 60)) /
                                            (1000 * 60),
                                    );
                                    const seconds = Math.floor(
                                        (distance % (1000 * 60)) / 1000,
                                    );

                                    const formattedMins =
                                        minutes < 10 ? "0" + minutes : minutes;
                                    const formattedSecs =
                                        seconds < 10 ? "0" + seconds : seconds;

                                    timer.innerHTML =
                                        formattedMins + ":" + formattedSecs;
                                    if (minutes === 0) {
                                        timer.parentElement.classList.remove(
                                            "text-primary",
                                        );
                                        timer.parentElement.classList.add(
                                            "text-danger",
                                        );
                                    }
                                }
                            }
                        });
                    }, 1000);
                }
                /* --- Automatically Open Tab from URL Hash --- */
                let urlHash = window.location.hash;
                if (urlHash) {
                    // Find the button that targets this exact hash
                    let targetButton = document.querySelector('button[data-bs-target="' + urlHash + '"]');
                    if (targetButton) {
                        // Use Bootstrap's built-in Tab API to switch to it
                        let tabInstance = new bootstrap.Tab(targetButton);
                        tabInstance.show();
                    }
                }
            });
        </script>
    </body>
</html>
